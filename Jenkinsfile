@Library("podTemplates") _
pipeline {
  parameters { booleanParam(name: 'FORCE_PUSH', defaultValue: false, description: 'Will force the publishing of the packages to the registry & repository') }
  environment {
    REGISTRY = "registry.crazyzone.be"
    NAME = 'harbor-vulnerability-exporter'
  } 
  agent {
    kubernetes {
      yaml getPodTemplate("buildkit")
    }
  }
  stages {
    stage('build') {
      when { anyOf {
        branch "master";
        branch "stable";
        branch "dev";
        expression{params.FORCE_PUSH == true }
      } }
      steps {
        container(name: 'buildkit', shell: '/bin/sh') {
          checkout \
            scm: [ $class: 'GitSCM', \
            branches: [[name: '*/' + env.BRANCH_NAME]],  \
            extensions: [[ 	$class: 'RelativeTargetDirectory', relativeTargetDir: 'harbor-vulnerability-metrics' ],
              [$class: 'CleanCheckout']],
            userRemoteConfigs: [[ \
              credentialsId: '5c22054e-0ebf-4b36-b190-e2e6a92049b7' \
              , url: 'ssh://git@git.crazyzone.be:30022:nvanlaerebeke/harbor-vulnerability-metrics.git' \
          ]]]
          sh getBuildScript(env.NAME, env.REGISTRY, env.GIT_BRANCH, readFile(env.NAME + '/VERSION'))
        }
      }
    }
  }
}
