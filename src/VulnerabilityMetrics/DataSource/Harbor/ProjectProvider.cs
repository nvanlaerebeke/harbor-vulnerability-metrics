using LanguageExt.Common;
using VulnerabilityMetrics.DataSource.Harbor.Request;

namespace VulnerabilityMetrics.DataSource.Harbor;

internal class ProjectProvider
{
    private readonly HarborApi _harborApi;
    private List<string> _projects;
    
    public ProjectProvider(HarborApi harborApi)
    {
        _harborApi = harborApi;
    }

    public async Task<Result<List<string>>> Get()
    {
        if (_projects is not null)
        {
            return new Result<List<string>>(_projects);
        }
        try
        {
            var result = await _harborApi.SendAsyncWithListResponse<Project>(new GetProjectsRequest());
            _projects = result.Select(p => p.Name).ToList();
            return new Result<List<string>>(_projects);
        }
        catch (Exception ex)
        {
            return new Result<List<string>>(new Exception($"[Error] {ex.Message}"));
        }
    }
}