using LanguageExt.Common;
using VulnerabilityMetrics.DataSource.Harbor.Request;

namespace VulnerabilityMetrics.DataSource.Harbor;

internal class ProjectProvider
{
    private readonly HarborApi _harborApi;
    private IEnumerable<string> _projects = Enumerable.Empty<string>();
    
    public ProjectProvider(HarborApi harborApi)
    {
        _harborApi = harborApi;
    }

    public async Task<IEnumerable<string>> Get()
    {
        if (_projects.Any())
        {
            return new List<string>(_projects);
        }
        try
        {
            var result = await _harborApi.SendAsyncWithListResponse<Project>(new GetProjectsRequest());
            _projects = result.Select(p => p.Name).ToList();
            return _projects;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            return Enumerable.Empty<string>();
        }
    }
}