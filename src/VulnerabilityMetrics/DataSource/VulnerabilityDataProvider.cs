using VulnerabilityMetrics.DataSource.Harbor;

namespace VulnerabilityMetrics.DataSource;

internal class VulnerabilityDataProvider
{
    private const int Interval = 5;
    private List<VulnerabilityReport> _vulnerabilityReports = new();
    private readonly VulnerabilityProvider _vulnerabilityProvider;
    
    public VulnerabilityDataProvider(HarborApi harborApi)
    {
        _vulnerabilityProvider = new(harborApi);
    }
    
    public async Task Start()
    {
        await Task.Run(async () =>
        {
            //ToDo: handle shutdown/cancellation
            while (true)
            {
                var result = await _vulnerabilityProvider.Get();
                _ = result.Match(report =>
                {
                    _vulnerabilityReports = report;
                    return true;
                }, ex =>
                {
                    Console.WriteLine(ex);
                    return false;
                });
                
                //Get the report every x seconds
                await Task.Delay(Interval * 1000);
            }
        });
    }
    
    public List<VulnerabilityReport> Get()
    {
        return _vulnerabilityReports;
    }
}