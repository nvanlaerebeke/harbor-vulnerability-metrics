using Serilog;
using VulnerabilityMetrics.DataSource;
using VulnerabilityMetrics.DataSource.Harbor;

//Logger
var logger = new LoggerConfiguration()
    .WriteTo.Console()
    .CreateLogger();

//Data Provider
logger.Information("Starting data provider...");
var vulnerabilityDataProvider = new VulnerabilityDataProvider(new HarborApi(), logger);
vulnerabilityDataProvider.Start().ConfigureAwait(false);

//Create the api application
logger.Information("Starting webserver...");
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapGet("/metrics", () =>
{
    
    logger.Information("Getting metrics");
    return vulnerabilityDataProvider.Get()
        .Aggregate(string.Empty, (current, report) => current + report);
});
app.MapGet("/", () => "Hello World");

//Start the application
app.Run();

//Cleanup
vulnerabilityDataProvider.Stop();