//Start fetching data from the harbor API

using System.Net;
using VulnerabilityMetrics.DataSource;
using VulnerabilityMetrics.DataSource.Harbor;

var serviceCollection = new ServiceCollection();
serviceCollection.AddHttpClient("HarborApi", c =>
{
    c.BaseAddress = new Uri(Environment.GetEnvironmentVariable("HARBOR_API"));
    c.DefaultRequestHeaders.Add("Accept", "application/json");
 
}).ConfigurePrimaryHttpMessageHandler(() => new HttpClientHandler()
{
    UseDefaultCredentials = true,
    Credentials = new NetworkCredential(
        Environment.GetEnvironmentVariable("HARBOR_USERNAME"), 
        Environment.GetEnvironmentVariable("HARBOR_PASSWORD")
    )
});
var serviceProvider = serviceCollection.BuildServiceProvider();
var vulnerabilityDataProvider = new VulnerabilityDataProvider(
    new HarborApi(serviceProvider.GetService<IHttpClientFactory>())
);
vulnerabilityDataProvider.Start();

//Create the application
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapGet("/metrics", () => vulnerabilityDataProvider.Get());
app.MapGet("/", () => "Hello World");

//Start the application
app.Run();